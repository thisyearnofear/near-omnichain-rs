<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Wallet Connections</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            padding: 12px 24px;
            margin: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background: #007bff;
            color: white;
            font-size: 16px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            background: #e9ecef;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Debug Wallet Connections</h1>
        
        <div id="status" class="status">Ready to test...</div>
        
        <div>
            <button onclick="testNearConnection()">Test NEAR Connection</button>
            <button onclick="testBaseConnection()">Test Base Connection</button>
            <button onclick="testButtonEvents()">Test Button Events</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <h3>Debug Log:</h3>
        <div id="log" class="log">Application starting...\n</div>
    </div>
    
    <script>
        let logElement = document.getElementById('log');
        let statusElement = document.getElementById('status');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logMessage = `[${timestamp}] ${message}\n`;
            logElement.textContent += logMessage;
            logElement.scrollTop = logElement.scrollHeight;
            
            if (type === 'error') {
                statusElement.textContent = message;
                statusElement.className = 'status error';
            } else if (type === 'success') {
                statusElement.textContent = message;
                statusElement.className = 'status success';
            } else {
                statusElement.textContent = message;
                statusElement.className = 'status';
            }
            
            console.log(logMessage);
        }
        
        function clearLog() {
            logElement.textContent = 'Log cleared...\n';
            statusElement.textContent = 'Ready to test...';
            statusElement.className = 'status';
        }
        
        function testButtonEvents() {
            log('Button events are working!', 'success');
        }
        
        async function testNearConnection() {
            try {
                log('Testing NEAR wallet connection...');
                
                // Check if we can access the NEAR wallet URL
                const walletUrl = 'https://app.mynearwallet.com/';
                log(`NEAR wallet URL: ${walletUrl}`);
                
                // Check URL parameters for existing connection
                const urlParams = new URLSearchParams(window.location.search);
                const accountId = urlParams.get('account_id');
                const publicKey = urlParams.get('public_key');
                
                if (accountId && publicKey) {
                    log(`Found NEAR callback: ${accountId}`, 'success');
                    
                    // Save to localStorage
                    localStorage.setItem('near_wallet_account_id', accountId);
                    
                    // Clean URL
                    const url = new URL(window.location);
                    url.searchParams.delete('account_id');
                    url.searchParams.delete('public_key');
                    url.searchParams.delete('all_keys');
                    window.history.replaceState({}, document.title, url.toString());
                    
                    log('NEAR wallet connected successfully!', 'success');
                    return;
                }
                
                // Check localStorage for existing connection
                const savedAccount = localStorage.getItem('near_wallet_account_id');
                if (savedAccount) {
                    log(`Found saved NEAR account: ${savedAccount}`, 'success');
                    return;
                }
                
                // Redirect to NEAR wallet
                log('Redirecting to NEAR wallet...');
                const currentUrl = new URL(window.location.href);
                currentUrl.searchParams.delete('account_id');
                currentUrl.searchParams.delete('public_key');
                currentUrl.searchParams.delete('all_keys');
                
                const nearWalletUrl = new URL('/login/', walletUrl);
                nearWalletUrl.searchParams.set('contract_id', 'bridge.near');
                nearWalletUrl.searchParams.set('success_url', currentUrl.toString());
                nearWalletUrl.searchParams.set('failure_url', currentUrl.toString());
                
                log(`Redirecting to: ${nearWalletUrl.toString()}`);
                
                // Confirm before redirect
                if (confirm('Redirect to NEAR wallet for authentication?')) {
                    window.location.href = nearWalletUrl.toString();
                } else {
                    log('User cancelled NEAR wallet redirect');
                }
                
            } catch (error) {
                log(`NEAR connection error: ${error.message}`, 'error');
                console.error('NEAR connection error:', error);
            }
        }
        
        async function testBaseConnection() {
            try {
                log('Testing Base wallet connection...');
                
                // Check if MetaMask is available
                if (!window.ethereum) {
                    log('MetaMask not detected', 'error');
                    return;
                }
                
                log('MetaMask detected');
                
                // Check current accounts
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                log(`Current accounts: ${accounts.length > 0 ? accounts[0] : 'none'}`);
                
                if (accounts.length === 0) {
                    log('Requesting account access...');
                    const newAccounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });
                    log(`Connected to: ${newAccounts[0]}`, 'success');
                } else {
                    log(`Already connected to: ${accounts[0]}`, 'success');
                }
                
                // Check current network
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdDecimal = parseInt(chainId, 16);
                log(`Current chain ID: ${chainIdDecimal} (${chainId})`);
                
                // Base Sepolia is 84532
                if (chainIdDecimal !== 84532) {
                    log('Not on Base Sepolia network, attempting to switch...');
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0x14a34' }], // 84532 in hex
                        });
                        log('Switched to Base Sepolia', 'success');
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            log('Base Sepolia not added, adding network...');
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: '0x14a34',
                                    chainName: 'Base Sepolia',
                                    rpcUrls: ['https://sepolia.base.org'],
                                    nativeCurrency: {
                                        name: 'Ethereum',
                                        symbol: 'ETH',
                                        decimals: 18
                                    },
                                    blockExplorerUrls: ['https://sepolia-explorer.base.org']
                                }],
                            });
                            log('Base Sepolia network added', 'success');
                        } else {
                            throw switchError;
                        }
                    }
                } else {
                    log('Already on Base Sepolia network', 'success');
                }
                
            } catch (error) {
                log(`Base connection error: ${error.message}`, 'error');
                console.error('Base connection error:', error);
            }
        }
        
        // Initialize
        log('Debug page loaded');
        log('Testing basic functionality...');
        
        // Test if we're in a NEAR callback
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('account_id')) {
            log('Detected NEAR wallet callback!');
            testNearConnection();
        }
        
        // Test MetaMask availability
        if (window.ethereum) {
            log('MetaMask detected');
        } else {
            log('MetaMask not detected');
        }
    </script>
</body>
</html>